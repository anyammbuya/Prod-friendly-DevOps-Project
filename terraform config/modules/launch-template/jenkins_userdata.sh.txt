#!/bin/bash
set -e
#-----------------------------------------------------------------------------
# ---------------| Installs initial plugins via jenkins cli |------------------
# ------------------------
# Update OS and install dependencies
# ------------------------
dnf upgrade -y || yum update -y
yum install -y wget git java-21-amazon-corretto

# ------------------------
# Install Maven manually into /opt
# ------------------------
MAVEN_VERSION=3.9.11
cd /opt
wget https://dlcdn.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz
tar -xvzf apache-maven-${MAVEN_VERSION}-bin.tar.gz
mv apache-maven-${MAVEN_VERSION} maven
rm -f apache-maven-${MAVEN_VERSION}-bin.tar.gz

# ------------------------
# Set environment variables
# ------------------------
cat <<'EOF' >> /etc/profile.d/maven.sh
export M2_HOME=/opt/maven
export M2=/opt/maven/bin
export JAVA_HOME=/usr/lib/jvm/java-21-amazon-corretto.x86_64
export PATH=$M2_HOME/bin:$JAVA_HOME/bin:$PATH
EOF
source /etc/profile.d/maven.sh

# ------------------------
# Install Jenkins
# ------------------------
wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key
yum install -y jenkins

# ------------------------
# Stop Jenkins if running
# ------------------------
systemctl stop jenkins || true

# ---------------------------
# Install aws cli
# ---------------------------
dnf install -y awscli

# ---------------------------
# Retrieve password from secrets manager
# ---------------------------
SECRET_NAME="jenkins-admin-password"
AWS_REGION="us-west-2"
ADMIN_PASSWORD=$(aws secretsmanager get-secret-value \
  --secret-id "$SECRET_NAME" \
  --region "$AWS_REGION" \
  --query "SecretString" \
  --output text)
  
if [ -z "$ADMIN_PASSWORD" ]; then
    echo "Error: Failed to retrieve ADMIN_PASSWORD from Secrets Manager"
    exit 1
fi

# ------------------------
# Empty Jenkins home and create directories
# ------------------------
rm -rf /var/lib/jenkins/*
mkdir -p /var/lib/jenkins/init.groovy.d

# ------------------------
# CRITICAL: Create admin user via init.groovy.d (NOT JCasC)
# ------------------------
cat <<EOF > /var/lib/jenkins/init.groovy.d/01-create-admin.groovy
import jenkins.model.*
import hudson.security.*

// Get Jenkins instance
def instance = Jenkins.get()

// Create local security realm with admin user
def hudsonRealm = new HudsonPrivateSecurityRealm(false)
hudsonRealm.createAccount('admin', '${ADMIN_PASSWORD}')
instance.setSecurityRealm(hudsonRealm)

// Use simpler authorization that's guaranteed to work
def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
strategy.setAllowAnonymousRead(false)
instance.setAuthorizationStrategy(strategy)

// Disable setup wizard
instance.setInstallState(InstallState.INITIAL_SETUP_COMPLETED)

// Save configuration
instance.save()
EOF

# ------------------------
# Create JCasC YAML for OTHER configurations (NOT security)
# Necessary for configuring plugins installed when starting Jenkins server
# You can leave it and do that later in the Jenkins as Code plugin. see jenk folder
# ------------------------
# cat <<'EOF' > /var/lib/jenkins/jenkins.yaml
# unclassified:
#   location:
#     url: "http://localhost:8080/"
# tool:
#   maven:
#     installations:
#       - name: "Maven-3.9.11"
#         home: "/opt/maven"
#   git:
#     installations:
#       - name: "Git"
#         home: "git"
# EOF

# ------------------------
# Set permissions
# ------------------------
chown -R jenkins:jenkins /var/lib/jenkins
#chmod 644 /var/lib/jenkins/jenkins.yaml
chmod 755 /var/lib/jenkins

# ------------------------
# Set JCasC environment variable
# ------------------------
echo 'CASC_JENKINS_CONFIG=/var/lib/jenkins/jenkins.yaml' >> /etc/sysconfig/jenkins

# ------------------------
# Start Jenkins and wait for it to be ready
# ------------------------
systemctl enable jenkins
systemctl start jenkins

echo "Waiting for Jenkins to start..."
sleep 30

# ------------------------
# Install plugins via CLI (now we have admin user)
# ------------------------
JENKINS_URL="http://localhost:8080"
while ! curl -s $JENKINS_URL > /dev/null; do
    echo "Waiting for Jenkins to be ready..."
    sleep 10
done

# Download jenkins-cli.jar
curl -s $JENKINS_URL/jnlpJars/jenkins-cli.jar -o /tmp/jenkins-cli.jar

# Install plugins using admin credentials
java -jar /tmp/jenkins-cli.jar -s $JENKINS_URL -auth admin:${ADMIN_PASSWORD} \
    install-plugin configuration-as-code git maven-plugin -restart

echo "Jenkins setup complete!"

# Wait for restart and apply full JCasC later if needed
sleep 30
echo "Setup finished! Access Jenkins at: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):8080"
# cat /var/log/cloud-init-output.log   see logs on ec2
# journalctl -u jenkins    see logs on jenkins application server