#!/bin/bash
set -e

#------------------------------------------------------------------------------------
# ---------------|             Uses Public github repo  |------------------------------

# ------------------------
# Update OS and install dependencies
# ------------------------
dnf upgrade -y || yum update -y
yum install -y wget git java-21-amazon-corretto

# ------------------------
# Install Maven manually into /opt (same as before)
# ------------------------
MAVEN_VERSION=3.9.11
cd /opt
wget https://dlcdn.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz
tar -xvzf apache-maven-${MAVEN_VERSION}-bin.tar.gz
mv apache-maven-${MAVEN_VERSION} maven
rm -f apache-maven-${MAVEN_VERSION}-bin.tar.gz

# ------------------------
# Set environment variables
# ------------------------
cat <<'EOF' >> /etc/profile.d/maven.sh
export M2_HOME=/opt/maven
export M2=/opt/maven/bin
export JAVA_HOME=/usr/lib/jvm/java-21-amazon-corretto.x86_64
export PATH=$M2_HOME/bin:$JAVA_HOME/bin:$PATH
EOF
source /etc/profile.d/maven.sh

# ------------------------
# Install Jenkins
# ------------------------
wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key
yum install -y jenkins

# ---------------------------
# Install aws cli
# ---------------------------
dnf install -y awscli

# ---------------------------
# Retrieve password from secrets manager
# ---------------------------
SECRET_NAME="jenkins-admin-password"
AWS_REGION="us-west-2"
ADMIN_PASSWORD=$(aws secretsmanager get-secret-value \
  --secret-id "$SECRET_NAME" \
  --region "$AWS_REGION" \
  --query "SecretString" \
  --output text)

if [ -z "$ADMIN_PASSWORD" ]; then
    echo "Error: Failed to retrieve ADMIN_PASSWORD from Secrets Manager"
    exit 1
fi

# ------------------------
# Prepare Jenkins home
# ------------------------
rm -rf /var/lib/jenkins/*
mkdir -p /var/lib/jenkins/init.groovy.d
mkdir -p /var/lib/jenkins/plugins

# ------------------------
# Create admin user via init.groovy.d
# ------------------------
cat <<EOF > /var/lib/jenkins/init.groovy.d/01-create-admin.groovy
import jenkins.model.*
import hudson.security.*

def instance = Jenkins.get()

def hudsonRealm = new HudsonPrivateSecurityRealm(false)
hudsonRealm.createAccount('admin', '${ADMIN_PASSWORD}')
instance.setSecurityRealm(hudsonRealm)

def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
strategy.setAllowAnonymousRead(false)
instance.setAuthorizationStrategy(strategy)

instance.save()
EOF

# ------------------------
# Install plugins using plugin-installation-manager tool
# ------------------------
# Download the tool
curl -L -o /opt/jenkins-plugin-manager.jar \
  https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/2.13.2/jenkins-plugin-manager-2.13.2.jar


# Download your plugin list (if remote)
mkdir -p /etc/jenkins

curl -L \
  https://raw.githubusercontent.com/anyammbuya/jenkinsJCasC/refs/heads/main/plugins.txt \
  -o /etc/jenkins/plugins.txt


# Run the tool before Jenkins starts
java -jar /opt/jenkins-plugin-manager.jar \
  --plugin-file /etc/jenkins/plugins.txt \
  --plugin-download-directory /var/lib/jenkins/plugins \
  --war /usr/lib/jenkins/jenkins.war \
  --clean-download-directory

# ------------------------
# Permissions
# ------------------------
chown -R jenkins:jenkins /var/lib/jenkins
chmod 755 /var/lib/jenkins

# ------------------------
# Create update-jenkins-plugins.sh script for later updates via SSM
# ------------------------
cat <<'EOF' > /etc/jenkins/update-jenkins-plugins.sh
#!/bin/bash
set -e
echo "Stopping Jenkins..."
systemctl stop jenkins

echo "Pulling latest plugins.txt from GitHub..."
curl -L \
  https://raw.githubusercontent.com/anyammbuya/jenkinsJCasC/refs/heads/main/plugins.txt \
  -o /etc/jenkins/plugins.txt

echo "Running plugin manager..."
java -jar /opt/jenkins-plugin-manager.jar \
  --plugin-file /etc/jenkins/plugins.txt \
  --plugin-download-directory /var/lib/jenkins/plugins \
  --war /usr/lib/jenkins/jenkins.war \
  --clean-download-directory

chown -R jenkins:jenkins /var/lib/jenkins

echo "Starting Jenkins..."
systemctl start jenkins
EOF

chmod +x /etc/jenkins/update-jenkins-plugins.sh

# ------------------------
# Start Jenkins
# ------------------------
systemctl enable jenkins
systemctl start jenkins

# cat /var/log/cloud-init-output.log   see logs on ec2
# journalctl -u jenkins    see logs on jenkins application server